# Start from the official NGINX image
FROM nginx:1.25-alpine

# Temporarily switch to root user for necessary setup
USER root

# Create and set permissions for NGINX cache directories
RUN mkdir -p /var/cache/nginx/{client_temp,proxy_temp,fastcgi_temp,uwsgi_temp,scgi_temp} \
    && chown -R nginx:nginx /var/cache/nginx

# Remove default.conf to avoid conflicts if custom configs are provided
RUN rm -f /etc/nginx/conf.d/default.conf

# Switch back to the non-root user
USER 1001

# Expose the necessary port
EXPOSE 8080

# Add custom configuration and static files
COPY nginx.conf /etc/nginx/nginx.conf
COPY ./html /usr/share/nginx/html

# Add custom entrypoint
COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# Set custom entrypoint
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]

# Set the default command
CMD ["nginx", "-g", "daemon off;"]
